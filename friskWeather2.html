<!doctype html>
<html lang="ja" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>friskWeather 2</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @keyframes scroll {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    
    .telop-scroll {
      animation: scroll 30s linear infinite;
      white-space: nowrap;
    }
    
    .weather-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .weather-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }
    
    .region-item {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .region-item:hover {
      transform: translateX(4px);
    }
    
    .time-display {
      font-family: 'Courier New', monospace;
      letter-spacing: 2px;
    }
    
    .weather-metric {
      transition: transform 0.2s ease;
    }
    
    .weather-metric:hover {
      transform: scale(1.05);
    }
    
    #radar-map {
      height: 400px;
      width: 100%;
      border-radius: 12px;
    }
    
    .leaflet-container {
      border-radius: 12px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <main id="app" class="h-full w-full overflow-auto"></main>
  <script>
    const defaultConfig = {
      main_title: "friskWeather 2",
      subtitle_text: "å…¨å›½ã®å¤©æ°—æƒ…å ±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§",
      footer_text: "ãƒ‡ãƒ¼ã‚¿æä¾›ï¼šæ°—è±¡åº / ã¤ãã¿å³¶API / Open-Meteo / ipapi",
      background_color: "#0f172a",
      card_color: "#ffffff",
      text_color: "#1f2937",
      primary_accent: "#3b82f6",
      secondary_accent: "#8b5cf6",
      font_family: "sans-serif",
      font_size: 16
    };

    const regionsData = {
      "åŒ—æµ·é“": {
        "çŸ³ç‹©åœ°æ–¹": [
          { name: "æœ­å¹Œ", code: "016010", lat: 43.06, lon: 141.35 }
        ],
        "æ¸¡å³¶åœ°æ–¹": [
          { name: "å‡½é¤¨", code: "017010", lat: 41.77, lon: 140.73 }
        ]
      },
      "é’æ£®çœŒ": {
        "æ´¥è»½åœ°æ–¹": [
          { name: "é’æ£®", code: "020010", lat: 40.82, lon: 140.75 }
        ]
      },
      "å²©æ‰‹çœŒ": {
        "å†…é™¸": [
          { name: "ç››å²¡", code: "030010", lat: 39.70, lon: 141.15 }
        ]
      },
      "å®®åŸçœŒ": {
        "æ±éƒ¨": [
          { name: "ä»™å°", code: "040010", lat: 38.27, lon: 140.87 }
        ]
      },
      "ç§‹ç”°çœŒ": {
        "æ²¿å²¸": [
          { name: "ç§‹ç”°", code: "050010", lat: 39.72, lon: 140.10 }
        ]
      },
      "å±±å½¢çœŒ": {
        "æ‘å±±": [
          { name: "å±±å½¢", code: "060010", lat: 38.25, lon: 140.34 }
        ]
      },
      "ç¦å³¶çœŒ": {
        "ä¸­é€šã‚Š": [
          { name: "ç¦å³¶", code: "070010", lat: 37.75, lon: 140.47 }
        ]
      },
      "èŒ¨åŸçœŒ": {
        "å—éƒ¨": [
          { name: "æ°´æˆ¸", code: "080010", lat: 36.34, lon: 140.47 }
        ]
      },
      "æ ƒæœ¨çœŒ": {
        "å—éƒ¨": [
          { name: "å®‡éƒ½å®®", code: "090010", lat: 36.56, lon: 139.88 }
        ]
      },
      "ç¾¤é¦¬çœŒ": {
        "å—éƒ¨": [
          { name: "å‰æ©‹", code: "100010", lat: 36.39, lon: 139.06 }
        ]
      },
      "åŸ¼ç‰çœŒ": {
        "å—éƒ¨": [
          { name: "ã•ã„ãŸã¾", code: "110010", lat: 35.86, lon: 139.65 }
        ]
      },
      "åƒè‘‰çœŒ": {
        "åŒ—è¥¿éƒ¨": [
          { name: "åƒè‘‰", code: "120010", lat: 35.61, lon: 140.12 }
        ]
      },
      "æ±äº¬éƒ½": {
        "æ±äº¬åœ°æ–¹": [
          { name: "æ±äº¬", code: "130010", lat: 35.69, lon: 139.69 },
          { name: "å…«ç‹å­", code: "130020", lat: 35.66, lon: 139.32 }
        ],
        "ä¼Šè±†è«¸å³¶": [
          { name: "å¤§å³¶", code: "130040", lat: 34.75, lon: 139.36 }
        ]
      },
      "ç¥å¥ˆå·çœŒ": {
        "æ±éƒ¨": [
          { name: "æ¨ªæµœ", code: "140010", lat: 35.44, lon: 139.64 }
        ]
      },
      "æ–°æ½ŸçœŒ": {
        "ä¸‹è¶Š": [
          { name: "æ–°æ½Ÿ", code: "150010", lat: 37.90, lon: 139.02 }
        ]
      },
      "å¯Œå±±çœŒ": {
        "æ±éƒ¨": [
          { name: "å¯Œå±±", code: "160010", lat: 36.70, lon: 137.21 }
        ]
      },
      "çŸ³å·çœŒ": {
        "åŠ è³€": [
          { name: "é‡‘æ²¢", code: "170010", lat: 36.59, lon: 136.63 }
        ]
      },
      "ç¦äº•çœŒ": {
        "å¶ºåŒ—": [
          { name: "ç¦äº•", code: "180010", lat: 36.06, lon: 136.22 }
        ]
      },
      "å±±æ¢¨çœŒ": {
        "ä¸­ãƒ»è¥¿éƒ¨": [
          { name: "ç”²åºœ", code: "190010", lat: 35.66, lon: 138.57 }
        ]
      },
      "é•·é‡çœŒ": {
        "åŒ—éƒ¨": [
          { name: "é•·é‡", code: "200010", lat: 36.65, lon: 138.19 }
        ]
      },
      "å²é˜œçœŒ": {
        "ç¾æ¿ƒåœ°æ–¹": [
          { name: "å²é˜œ", code: "210010", lat: 35.42, lon: 136.76 }
        ]
      },
      "é™å²¡çœŒ": {
        "ä¸­éƒ¨": [
          { name: "é™å²¡", code: "220010", lat: 34.98, lon: 138.38 }
        ]
      },
      "æ„›çŸ¥çœŒ": {
        "è¥¿éƒ¨": [
          { name: "åå¤å±‹", code: "230010", lat: 35.18, lon: 136.91 }
        ]
      },
      "ä¸‰é‡çœŒ": {
        "åŒ—ä¸­éƒ¨": [
          { name: "æ´¥", code: "240010", lat: 34.73, lon: 136.51 }
        ]
      },
      "æ»‹è³€çœŒ": {
        "å—éƒ¨": [
          { name: "å¤§æ´¥", code: "250010", lat: 35.00, lon: 135.87 }
        ]
      },
      "äº¬éƒ½åºœ": {
        "å—éƒ¨": [
          { name: "äº¬éƒ½", code: "260010", lat: 35.02, lon: 135.75 }
        ]
      },
      "å¤§é˜ªåºœ": {
        "å¤§é˜ªåºœ": [
          { name: "å¤§é˜ª", code: "270000", lat: 34.69, lon: 135.50 }
        ]
      },
      "å…µåº«çœŒ": {
        "å—éƒ¨": [
          { name: "ç¥æˆ¸", code: "280010", lat: 34.69, lon: 135.20 }
        ]
      },
      "å¥ˆè‰¯çœŒ": {
        "åŒ—éƒ¨": [
          { name: "å¥ˆè‰¯", code: "290010", lat: 34.69, lon: 135.83 }
        ]
      },
      "å’Œæ­Œå±±çœŒ": {
        "åŒ—éƒ¨": [
          { name: "å’Œæ­Œå±±", code: "300010", lat: 34.23, lon: 135.17 }
        ]
      },
      "é³¥å–çœŒ": {
        "æ±éƒ¨": [
          { name: "é³¥å–", code: "310010", lat: 35.50, lon: 134.24 }
        ]
      },
      "å³¶æ ¹çœŒ": {
        "æ±éƒ¨": [
          { name: "æ¾æ±Ÿ", code: "320010", lat: 35.47, lon: 133.05 }
        ]
      },
      "å²¡å±±çœŒ": {
        "å—éƒ¨": [
          { name: "å²¡å±±", code: "330010", lat: 34.66, lon: 133.92 }
        ]
      },
      "åºƒå³¶çœŒ": {
        "å—éƒ¨": [
          { name: "åºƒå³¶", code: "340010", lat: 34.40, lon: 132.46 }
        ]
      },
      "å±±å£çœŒ": {
        "è¥¿éƒ¨": [
          { name: "ä¸‹é–¢", code: "350010", lat: 33.96, lon: 130.94 }
        ]
      },
      "å¾³å³¶çœŒ": {
        "åŒ—éƒ¨": [
          { name: "å¾³å³¶", code: "360010", lat: 34.07, lon: 134.56 }
        ]
      },
      "é¦™å·çœŒ": {
        "é¦™å·çœŒ": [
          { name: "é«˜æ¾", code: "370000", lat: 34.34, lon: 134.04 }
        ]
      },
      "æ„›åª›çœŒ": {
        "ä¸­äºˆ": [
          { name: "æ¾å±±", code: "380010", lat: 33.84, lon: 132.77 }
        ]
      },
      "é«˜çŸ¥çœŒ": {
        "ä¸­éƒ¨": [
          { name: "é«˜çŸ¥", code: "390010", lat: 33.56, lon: 133.53 }
        ]
      },
      "ç¦å²¡çœŒ": {
        "ç¦å²¡åœ°æ–¹": [
          { name: "ç¦å²¡", code: "400010", lat: 33.59, lon: 130.40 }
        ]
      },
      "ä½è³€çœŒ": {
        "å—éƒ¨": [
          { name: "ä½è³€", code: "410010", lat: 33.25, lon: 130.30 }
        ]
      },
      "é•·å´çœŒ": {
        "å—éƒ¨": [
          { name: "é•·å´", code: "420010", lat: 32.74, lon: 129.87 }
        ]
      },
      "ç†Šæœ¬çœŒ": {
        "ç†Šæœ¬åœ°æ–¹": [
          { name: "ç†Šæœ¬", code: "430010", lat: 32.79, lon: 130.74 }
        ]
      },
      "å¤§åˆ†çœŒ": {
        "ä¸­éƒ¨": [
          { name: "å¤§åˆ†", code: "440010", lat: 33.24, lon: 131.61 }
        ]
      },
      "å®®å´çœŒ": {
        "å—éƒ¨å¹³é‡éƒ¨": [
          { name: "å®®å´", code: "450010", lat: 31.91, lon: 131.42 }
        ]
      },
      "é¹¿å…å³¶çœŒ": {
        "è–©æ‘©åœ°æ–¹": [
          { name: "é¹¿å…å³¶", code: "460010", lat: 31.60, lon: 130.56 }
        ]
      },
      "æ²–ç¸„çœŒ": {
        "æœ¬å³¶ä¸­å—éƒ¨": [
          { name: "é‚£è¦‡", code: "471010", lat: 26.21, lon: 127.68 }
        ]
      }
    };

    let selectedPrefecture = "æ±äº¬éƒ½";
    let selectedArea = "æ±äº¬åœ°æ–¹";
    let selectedCity = null;
    let weatherData = null;
    let meteoData = null;
    let typhoonData = [];
    let radarMap = null;
    let radarLayer = null;
    let radarTimes = [];
    let currentRadarIndex = 0;
    let radarAnimationInterval = null;
    let currentTime = new Date();
    let autoDetectedLocation = null;

    setInterval(() => {
      currentTime = new Date();
      updateTimeDisplay();
    }, 10);

    function updateTimeDisplay() {
      const timeElement = document.getElementById('realtime-clock');
      if (timeElement) {
        const hours = String(currentTime.getHours()).padStart(2, '0');
        const minutes = String(currentTime.getMinutes()).padStart(2, '0');
        const seconds = String(currentTime.getSeconds()).padStart(2, '0');
        const milliseconds = String(currentTime.getMilliseconds()).padStart(3, '0');
        const subseconds = milliseconds.substring(0, 2);
        
        timeElement.textContent = `${hours}:${minutes}:${seconds}.${subseconds}`;
      }
    }

    async function detectLocation() {
      try {
        const ipResponse = await fetch('https://api.ipify.org/?format=json');
        const ipData = await ipResponse.json();
        
        const locationResponse = await fetch(`https://ipapi.co/${ipData.ip}/json/`);
        const locationData = await locationResponse.json();
        
        if (locationData.city && locationData.region) {
          autoDetectedLocation = {
            city: locationData.city,
            region: locationData.region,
            lat: locationData.latitude,
            lon: locationData.longitude
          };
          
          let closestCity = null;
          let minDistance = Infinity;
          
          for (const [prefecture, areas] of Object.entries(regionsData)) {
            for (const [area, cities] of Object.entries(areas)) {
              for (const city of cities) {
                const distance = Math.sqrt(
                  Math.pow(city.lat - locationData.latitude, 2) + 
                  Math.pow(city.lon - locationData.longitude, 2)
                );
                if (distance < minDistance) {
                  minDistance = distance;
                  closestCity = { prefecture, area, city };
                }
              }
            }
          }
          
          if (closestCity) {
            selectedPrefecture = closestCity.prefecture;
            selectedArea = closestCity.area;
            selectedCity = closestCity.city;
          }
        }
      } catch (error) {
        console.error('Location detection error:', error);
      }
    }

    async function fetchWeatherData(city) {
      try {
        const response = await fetch(`https://weather.tsukumijima.net/api/forecast/city/${city.code}`);
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Weather data fetch error:', error);
        return null;
      }
    }

    async function fetchMeteoData(city) {
      try {
        const response = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&hourly=wind_gusts_10m,wind_speed_10m,cloudcover,snowfall,relative_humidity_2m&current=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m&timezone=Asia/Tokyo`
        );
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Meteo data fetch error:', error);
        return null;
      }
    }

    async function fetchTyphoonData() {
      try {
        const response = await fetch('https://www.data.jma.go.jp/developer/xml/feed/extra.xml');
        const text = await response.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, 'text/xml');
        const entries = xml.querySelectorAll('entry');
        
        const typhoons = [];
        entries.forEach(entry => {
          const title = entry.querySelector('title')?.textContent || '';
          if (title.includes('å°é¢¨')) {
            typhoons.push({
              title: title,
              updated: entry.querySelector('updated')?.textContent || ''
            });
          }
        });
        
        return typhoons.slice(0, 3);
      } catch (error) {
        console.error('Typhoon data fetch error:', error);
        return [];
      }
    }

    async function fetchRadarTimes() {
      try {
        const response = await fetch('https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json');
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Radar times fetch error:', error);
        return [];
      }
    }

    function getWeatherEmoji(telop) {
      if (!telop) return 'â˜ï¸';
      if (telop.includes('æ™´')) return 'â˜€ï¸';
      if (telop.includes('æ›‡')) return 'â˜ï¸';
      if (telop.includes('é›¨')) return 'ğŸŒ§ï¸';
      if (telop.includes('é›ª')) return 'â„ï¸';
      if (telop.includes('é›·')) return 'âš¡';
      return 'â˜ï¸';
    }

    function getWindDirection(degrees) {
      const directions = ['åŒ—', 'åŒ—æ±', 'æ±', 'å—æ±', 'å—', 'å—è¥¿', 'è¥¿', 'åŒ—è¥¿'];
      const index = Math.round(degrees / 45) % 8;
      return directions[index];
    }

    function calculateFeelsLike(temp, humidity, windSpeed) {
      if (temp >= 10) {
        const humidityFactor = (humidity - 50) * 0.1;
        return Math.round((temp + humidityFactor - windSpeed * 0.5) * 10) / 10;
      } else {
        const windChill = 13.12 + 0.6215 * temp - 11.37 * Math.pow(windSpeed * 3.6, 0.16) + 0.3965 * temp * Math.pow(windSpeed * 3.6, 0.16);
        return Math.round(windChill * 10) / 10;
      }
    }

    function initRadarMap() {
      if (!selectedCity) return;
      
      const mapElement = document.getElementById('radar-map');
      if (!mapElement) return;
      
      if (radarMap) {
        radarMap.remove();
      }
      
      radarMap = L.map('radar-map').setView([selectedCity.lat, selectedCity.lon], 9);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(radarMap);
      
      updateRadarLayer();
    }

    async function updateRadarLayer() {
      if (!radarMap) return;
      
      radarTimes = await fetchRadarTimes();
      if (radarTimes.length === 0) return;
      
      currentRadarIndex = radarTimes.length - 1;
      displayRadarAtIndex(currentRadarIndex);
      updateRadarTimeDisplay();
    }

    function displayRadarAtIndex(index) {
      if (!radarMap || !radarTimes[index]) return;
      
      if (radarLayer) {
        radarMap.removeLayer(radarLayer);
      }
      
      const time = radarTimes[index].basetime;
      const validtime = radarTimes[index].validtime;
      
      radarLayer = L.tileLayer(
        `https://www.jma.go.jp/bosai/jmatile/data/nowc/${time}/none/${validtime}/surf/hrpns/{z}/{x}/{y}.png`,
        {
          opacity: 0.7,
          maxZoom: 10
        }
      ).addTo(radarMap);
    }

    function updateRadarTimeDisplay() {
      const timeDisplay = document.getElementById('radar-time-display');
      if (timeDisplay && radarTimes[currentRadarIndex]) {
        const time = new Date(radarTimes[currentRadarIndex].basetime);
        timeDisplay.textContent = `è¡¨ç¤ºæ™‚åˆ»ï¼š${time.getHours()}æ™‚${String(time.getMinutes()).padStart(2, '0')}åˆ†`;
      }
    }

    function playRadarAnimation() {
      if (radarAnimationInterval) return;
      
      radarAnimationInterval = setInterval(() => {
        currentRadarIndex = (currentRadarIndex + 1) % radarTimes.length;
        displayRadarAtIndex(currentRadarIndex);
        updateRadarTimeDisplay();
      }, 500);
    }

    function stopRadarAnimation() {
      if (radarAnimationInterval) {
        clearInterval(radarAnimationInterval);
        radarAnimationInterval = null;
      }
    }

    async function renderApp() {
      const config = window.elementSdk?.config || defaultConfig;
      const app = document.getElementById('app');
      
      const bgColor = config.background_color || defaultConfig.background_color;
      const cardColor = config.card_color || defaultConfig.card_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryAccent = config.primary_accent || defaultConfig.primary_accent;
      const secondaryAccent = config.secondary_accent || defaultConfig.secondary_accent;
      const fontFamily = config.font_family || defaultConfig.font_family;
      const baseFontSize = config.font_size || defaultConfig.font_size;
      const fontStack = `${fontFamily}, sans-serif`;

      app.style.backgroundColor = bgColor;
      app.style.color = cardColor;
      app.style.fontFamily = fontStack;
      
      if (!selectedCity) {
        selectedCity = regionsData[selectedPrefecture][selectedArea][0];
      }
      
      app.innerHTML = `
        <div style="min-height: 100%; display: flex; flex-direction: column;">
          <header style="background: linear-gradient(135deg, ${primaryAccent}, ${secondaryAccent}); padding: ${baseFontSize * 1.5}px ${baseFontSize}px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="max-width: 1400px; margin: 0 auto;">
              <h1 id="main-title" style="font-size: ${baseFontSize * 2}px; font-weight: bold; margin: 0; text-align: center; color: white;">${config.main_title || defaultConfig.main_title}</h1>
              <p id="subtitle" style="font-size: ${baseFontSize}px; margin: ${baseFontSize * 0.5}px 0 0 0; text-align: center; opacity: 0.95; color: white;">${config.subtitle_text || defaultConfig.subtitle_text}</p>
              <div style="margin-top: ${baseFontSize}px; display: flex; justify-content: center; align-items: center; gap: ${baseFontSize}px;">
                <div class="time-display" id="realtime-clock" style="font-size: ${baseFontSize * 1.5}px; color: white; font-weight: bold;"></div>
              </div>
              ${autoDetectedLocation ? `
                <div style="text-align: center; margin-top: ${baseFontSize * 0.5}px; font-size: ${baseFontSize * 0.875}px; color: white; opacity: 0.9;">
                  ğŸ“ ç¾åœ¨åœ°ï¼š${autoDetectedLocation.city}ï¼ˆè‡ªå‹•åˆ¤å®šï¼‰
                </div>
              ` : ''}
            </div>
          </header>

          <div id="telop-container" style="background-color: ${secondaryAccent}; color: white; padding: ${baseFontSize * 0.75}px 0; overflow: hidden;"></div>

          <div style="flex: 1; padding: ${baseFontSize * 1.5}px ${baseFontSize}px; max-width: 1400px; margin: 0 auto; width: 100%;">
            <div style="display: grid; grid-template-columns: 280px 1fr; gap: ${baseFontSize * 1.5}px;">
              <aside style="background-color: ${cardColor}; padding: ${baseFontSize * 1.5}px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: fit-content;">
                <h2 style="font-size: ${baseFontSize * 1.25}px; font-weight: bold; margin: 0 0 ${baseFontSize}px 0; color: ${textColor};">åœ°åŸŸé¸æŠ</h2>
                
                <div style="margin-bottom: ${baseFontSize}px;">
                  <label for="prefecture-select" style="display: block; font-size: ${baseFontSize * 0.875}px; margin-bottom: ${baseFontSize * 0.25}px; color: ${textColor}; font-weight: 600;">éƒ½é“åºœçœŒ</label>
                  <select id="prefecture-select" style="width: 100%; padding: ${baseFontSize * 0.5}px; border: 2px solid ${primaryAccent}; border-radius: 6px; font-size: ${baseFontSize}px; color: ${textColor}; background-color: white;">
                    ${Object.keys(regionsData).map(pref => 
                      `<option value="${pref}" ${pref === selectedPrefecture ? 'selected' : ''}>${pref}</option>`
                    ).join('')}
                  </select>
                </div>
                
                <div style="margin-bottom: ${baseFontSize}px;">
                  <label for="area-select" style="display: block; font-size: ${baseFontSize * 0.875}px; margin-bottom: ${baseFontSize * 0.25}px; color: ${textColor}; font-weight: 600;">åœ°åŸŸ</label>
                  <select id="area-select" style="width: 100%; padding: ${baseFontSize * 0.5}px; border: 2px solid ${primaryAccent}; border-radius: 6px; font-size: ${baseFontSize}px; color: ${textColor}; background-color: white;"></select>
                </div>
                
                <div>
                  <div style="display: block; font-size: ${baseFontSize * 0.875}px; margin-bottom: ${baseFontSize * 0.5}px; color: ${textColor}; font-weight: 600;">å¸‚ç”ºæ‘</div>
                  <div id="city-list" style="display: flex; flex-direction: column; gap: ${baseFontSize * 0.25}px;"></div>
                </div>
              </aside>

              <div style="display: flex; flex-direction: column; gap: ${baseFontSize * 1.5}px;">
                <div id="weather-today" class="weather-card" style="background-color: ${cardColor}; padding: ${baseFontSize * 2}px; border-radius: 16px; box-shadow: 0 8px 16px rgba(0,0,0,0.15);"></div>
                
                <div id="weather-tomorrow" class="weather-card" style="background-color: ${cardColor}; padding: ${baseFontSize * 1.5}px; border-radius: 16px; box-shadow: 0 8px 16px rgba(0,0,0,0.15);"></div>
                
                <div id="meteo-data-container" class="weather-card" style="background-color: ${cardColor}; padding: ${baseFontSize * 1.5}px; border-radius: 16px; box-shadow: 0 8px 16px rgba(0,0,0,0.15);"></div>
                
                <div id="radar-container" class="weather-card" style="background-color: ${cardColor}; padding: ${baseFontSize * 1.5}px; border-radius: 16px; box-shadow: 0 8px 16px rgba(0,0,0,0.15);">
                  <h3 style="font-size: ${baseFontSize * 1.5}px; font-weight: bold; margin: 0 0 ${baseFontSize}px 0; color: ${textColor};">é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼</h3>
                  <div id="radar-time-display" style="text-align: center; margin-bottom: ${baseFontSize * 0.5}px; font-size: ${baseFontSize * 0.875}px; color: ${textColor}; font-weight: 600;"></div>
                  <div id="radar-map"></div>
                  <div style="display: flex; justify-content: center; gap: ${baseFontSize}px; margin-top: ${baseFontSize}px;">
                    <button id="radar-play" style="padding: ${baseFontSize * 0.5}px ${baseFontSize * 1.5}px; background-color: ${primaryAccent}; color: white; border: none; border-radius: 6px; font-size: ${baseFontSize}px; cursor: pointer; font-weight: 600;">å†ç”Ÿ</button>
                    <button id="radar-stop" style="padding: ${baseFontSize * 0.5}px ${baseFontSize * 1.5}px; background-color: ${textColor}; color: white; border: none; border-radius: 6px; font-size: ${baseFontSize}px; cursor: pointer; font-weight: 600;">åœæ­¢</button>
                    <button id="radar-latest" style="padding: ${baseFontSize * 0.5}px ${baseFontSize * 1.5}px; background-color: ${secondaryAccent}; color: white; border: none; border-radius: 6px; font-size: ${baseFontSize}px; cursor: pointer; font-weight: 600;">æœ€æ–°ã«æˆ»ã‚‹</button>
                  </div>
                </div>
                
                <div id="typhoon-container" class="weather-card" style="background-color: ${cardColor}; padding: ${baseFontSize * 1.5}px; border-radius: 16px; box-shadow: 0 8px 16px rgba(0,0,0,0.15);"></div>
              </div>
            </div>
          </div>

          <footer style="background-color: ${cardColor}; padding: ${baseFontSize * 1.5}px; text-align: center; border-top: 2px solid ${primaryAccent}; margin-top: ${baseFontSize * 2}px;">
            <p id="footer-text" style="font-size: ${baseFontSize * 0.875}px; margin: 0; color: ${textColor}; opacity: 0.8;">${config.footer_text || defaultConfig.footer_text}</p>
          </footer>
        </div>
      `;

      updateTimeDisplay();
      setupRegionSelectors();
      await updateWeatherDisplay();
      initRadarMap();
      setupRadarControls();
      await updateTyphoonDisplay();
    }

    function setupRegionSelectors() {
      const prefectureSelect = document.getElementById('prefecture-select');
      const areaSelect = document.getElementById('area-select');
      
      prefectureSelect.addEventListener('change', (e) => {
        selectedPrefecture = e.target.value;
        selectedArea = Object.keys(regionsData[selectedPrefecture])[0];
        selectedCity = regionsData[selectedPrefecture][selectedArea][0];
        updateAreaSelect();
        updateCityList();
        updateWeatherDisplay();
        if (radarMap) {
          radarMap.setView([selectedCity.lat, selectedCity.lon], 9);
          updateRadarLayer();
        }
      });
      
      areaSelect.addEventListener('change', (e) => {
        selectedArea = e.target.value;
        selectedCity = regionsData[selectedPrefecture][selectedArea][0];
        updateCityList();
        updateWeatherDisplay();
        if (radarMap) {
          radarMap.setView([selectedCity.lat, selectedCity.lon], 9);
          updateRadarLayer();
        }
      });
      
      updateAreaSelect();
      updateCityList();
    }

    function updateAreaSelect() {
      const areaSelect = document.getElementById('area-select');
      const areas = Object.keys(regionsData[selectedPrefecture]);
      
      areaSelect.innerHTML = areas.map(area => 
        `<option value="${area}" ${area === selectedArea ? 'selected' : ''}>${area}</option>`
      ).join('');
    }

    function updateCityList() {
      const config = window.elementSdk?.config || defaultConfig;
      const baseFontSize = config.font_size || defaultConfig.font_size;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryAccent = config.primary_accent || defaultConfig.primary_accent;
      
      const cityList = document.getElementById('city-list');
      const cities = regionsData[selectedPrefecture][selectedArea];
      
      cityList.innerHTML = cities.map(city => `
        <div class="region-item" data-code="${city.code}" style="padding: ${baseFontSize * 0.5}px ${baseFontSize * 0.75}px; border-radius: 6px; font-size: ${baseFontSize}px; cursor: pointer; background-color: ${city.code === selectedCity.code ? primaryAccent : 'transparent'}; color: ${city.code === selectedCity.code ? 'white' : textColor};">
          ${city.name}
        </div>
      `).join('');
      
      document.querySelectorAll('.region-item').forEach(item => {
        item.addEventListener('click', (e) => {
          const code = e.currentTarget.getAttribute('data-code');
          selectedCity = cities.find(c => c.code === code);
          updateCityList();
          updateWeatherDisplay();
          if (radarMap) {
            radarMap.setView([selectedCity.lat, selectedCity.lon], 9);
            updateRadarLayer();
          }
        });
      });
    }

    async function updateWeatherDisplay() {
      const config = window.elementSdk?.config || defaultConfig;
      const baseFontSize = config.font_size || defaultConfig.font_size;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryAccent = config.primary_accent || defaultConfig.primary_accent;
      const secondaryAccent = config.secondary_accent || defaultConfig.secondary_accent;
      
      weatherData = await fetchWeatherData(selectedCity);
      meteoData = await fetchMeteoData(selectedCity);
      
      if (weatherData && weatherData.forecasts) {
        const today = weatherData.forecasts[0];
        const tomorrow = weatherData.forecasts[1];
        
        const todayDiv = document.getElementById('weather-today');
        if (todayDiv && today) {
          const emoji = getWeatherEmoji(today.telop);
          todayDiv.innerHTML = `
            <div style="text-align: center; color: ${textColor};">
              <div style="font-size: ${baseFontSize * 5}px; margin-bottom: ${baseFontSize}px;">${emoji}</div>
              <h2 style="font-size: ${baseFontSize * 2}px; font-weight: bold; margin: 0 0 ${baseFontSize * 0.5}px 0; color: ${primaryAccent};">${selectedCity.name} - ä»Šæ—¥</h2>
              <p style="font-size: ${baseFontSize * 1.5}px; margin: 0; font-weight: 600;">${today.telop || 'æƒ…å ±ãªã—'}</p>
              ${today.temperature?.max?.celsius ? `
                <div style="margin-top: ${baseFontSize * 1.5}px; display: flex; justify-content: center; gap: ${baseFontSize * 2}px;">
                  <div>
                    <span style="font-size: ${baseFontSize * 0.875}px; opacity: 0.7;">æœ€é«˜</span>
                    <div style="font-size: ${baseFontSize * 2}px; font-weight: bold; color: ${secondaryAccent};">${today.temperature.max.celsius}Â°C</div>
                  </div>
                  <div>
                    <span style="font-size: ${baseFontSize * 0.875}px; opacity: 0.7;">æœ€ä½</span>
                    <div style="font-size: ${baseFontSize * 2}px; font-weight: bold; color: ${primaryAccent};">${today.temperature.min?.celsius || '--'}Â°C</div>
                  </div>
                </div>
              ` : ''}
              ${meteoData && meteoData.current ? `
                <div style="margin-top: ${baseFontSize * 1.5}px; padding: ${baseFontSize * 1.5}px; background-color: rgba(139, 92, 246, 0.1); border-radius: 12px;">
                  <div style="text-align: center; margin-bottom: ${baseFontSize}px;">
                    <div style="font-size: ${baseFontSize * 0.875}px; opacity: 0.7; margin-bottom: ${baseFontSize * 0.25}px;">ğŸŒ¡ï¸ ä½“æ„Ÿæ¸©åº¦</div>
                    <div style="font-size: ${baseFontSize * 2.5}px; font-weight: bold; color: ${secondaryAccent};">${calculateFeelsLike(meteoData.current.temperature_2m, meteoData.current.relative_humidity_2m, meteoData.current.wind_speed_10m)}Â°C</div>
                    <div style="font-size: ${baseFontSize * 0.75}px; opacity: 0.6; margin-top: ${baseFontSize * 0.25}px;">æ¹¿åº¦ãƒ»é¢¨é€Ÿã‹ã‚‰ç®—å‡º</div>
                  </div>
                  <div style="display: flex; justify-content: center; gap: ${baseFontSize * 2}px; padding-top: ${baseFontSize}px; border-top: 1px solid rgba(139, 92, 246, 0.2);">
                    <div style="text-align: center;">
                      <div style="font-size: ${baseFontSize * 0.875}px; opacity: 0.7; margin-bottom: ${baseFontSize * 0.25}px;">ğŸ’§ æ¹¿åº¦</div>
                      <div style="font-size: ${baseFontSize * 1.25}px; font-weight: bold;">${meteoData.current.relative_humidity_2m}%</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: ${baseFontSize * 0.875}px; opacity: 0.7; margin-bottom: ${baseFontSize * 0.25}px;">ğŸ’¨ é¢¨é€Ÿ</div>
                      <div style="font-size: ${baseFontSize * 1.25}px; font-weight: bold;">${meteoData.current.wind_speed_10m} m/s</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: ${baseFontSize * 0.875}px; opacity: 0.7; margin-bottom: ${baseFontSize * 0.25}px;">ğŸ§­ é¢¨å‘</div>
                      <div style="font-size: ${baseFontSize * 1.25}px; font-weight: bold;">${getWindDirection(meteoData.current.wind_direction_10m)}</div>
                    </div>
                  </div>
                </div>
              ` : ''}
              ${today.chanceOfRain ? `
                <div style="margin-top: ${baseFontSize}px;">
                  <div style="font-size: ${baseFontSize * 0.875}px; font-weight: 600; margin-bottom: ${baseFontSize * 0.5}px; opacity: 0.8;">â˜” é™æ°´ç¢ºç‡</div>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: ${baseFontSize * 0.5}px;">
                    <div style="padding: ${baseFontSize * 0.5}px; background-color: rgba(59, 130, 246, 0.1); border-radius: 6px;">
                      <div style="font-size: ${baseFontSize * 0.75}px; opacity: 0.7;">0-6æ™‚</div>
                      <div style="font-size: ${baseFontSize}px; font-weight: bold;">${today.chanceOfRain.T00_06 || '--'}</div>
                    </div>
                    <div style="padding: ${baseFontSize * 0.5}px; background-color: rgba(59, 130, 246, 0.1); border-radius: 6px;">
                      <div style="font-size: ${baseFontSize * 0.75}px; opacity: 0.7;">6-12æ™‚</div>
                      <div style="font-size: ${baseFontSize}px; font-weight: bold;">${today.chanceOfRain.T06_12 || '--'}</div>
                    </div>
                    <div style="padding: ${baseFontSize * 0.5}px; background-color: rgba(59, 130, 246, 0.1); border-radius: 6px;">
                      <div style="font-size: ${baseFontSize * 0.75}px; opacity: 0.7;">12-18æ™‚</div>
                      <div style="font-size: ${baseFontSize}px; font-weight: bold;">${today.chanceOfRain.T12_18 || '--'}</div>
                    </div>
                    <div style="padding: ${baseFontSize * 0.5}px; background-color: rgba(59, 130, 246, 0.1); border-radius: 6px;">
                      <div style="font-size: ${baseFontSize * 0.75}px; opacity: 0.7;">18-24æ™‚</div>
                      <div style="font-size: ${baseFontSize}px; font-weight: bold;">${today.chanceOfRain.T18_24 || '--'}</div>
                    </div>
                  </div>
                </div>
              ` : ''}
            </div>
          `;
        }
        
        const tomorrowDiv = document.getElementById('weather-tomorrow');
        if (tomorrowDiv && tomorrow) {
          const emoji = getWeatherEmoji(tomorrow.telop);
          tomorrowDiv.innerHTML = `
            <h3 style="font-size: ${baseFontSize * 1.5}px; font-weight: bold; margin: 0 0 ${baseFontSize}px 0; color: ${textColor};">æ˜æ—¥ã®å¤©æ°—</h3>
            <div style="display: flex; align-items: center; gap: ${baseFontSize * 1.5}px; color: ${textColor};">
              <div style="font-size: ${baseFontSize * 3}px;">${emoji}</div>
              <div style="flex: 1;">
                <p style="font-size: ${baseFontSize * 1.25}px; margin: 0; font-weight: 600;">${tomorrow.telop || 'æƒ…å ±ãªã—'}</p>
                ${tomorrow.temperature?.max?.celsius ? `
                  <div style="display: flex; gap: ${baseFontSize}px; margin-top: ${baseFontSize * 0.5}px;">
                    <span style="font-size: ${baseFontSize}px;">æœ€é«˜ <strong style="color: ${secondaryAccent};">${tomorrow.temperature.max.celsius}Â°C</strong></span>
                    <span style="font-size: ${baseFontSize}px;">æœ€ä½ <strong style="color: ${primaryAccent};">${tomorrow.temperature.min?.celsius || '--'}Â°C</strong></span>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }
        
        const telopContainer = document.getElementById('telop-container');
        if (telopContainer && today.detail?.weather) {
          telopContainer.innerHTML = `
            <div class="telop-scroll" style="font-size: ${baseFontSize}px; display: inline-block;">
              ã€${selectedCity.name}ã€‘${today.detail.weather}ã€€ã€€ã€€
            </div>
          `;
        }
      }
      
      if (meteoData && meteoData.current) {
        const current = meteoData.current;
        const meteoDiv = document.getElementById('meteo-data-container');
        if (meteoDiv) {
          meteoDiv.innerHTML = `
            <h3 style="font-size: ${baseFontSize * 1.5}px; font-weight: bold; margin: 0 0 ${baseFontSize}px 0; color: ${textColor};">è©³ç´°æ°—è±¡ãƒ‡ãƒ¼ã‚¿</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: ${baseFontSize}px;">
              <div class="weather-metric" style="background-color: rgba(59, 130, 246, 0.1); padding: ${baseFontSize}px; border-radius: 8px; text-align: center; color: ${textColor};">
                <div style="font-size: ${baseFontSize * 0.875}px; opacity: 0.7; margin-bottom: ${baseFontSize * 0.25}px;">ç¾åœ¨æ°—æ¸©</div>
                <div style="font-size: ${baseFontSize * 1.75}px; font-weight: bold; color: ${primaryAccent};">${current.temperature_2m}Â°C</div>
              </div>
              <div class="weather-metric" style="background-color: rgba(59, 130, 246, 0.1); padding: ${baseFontSize}px; border-radius: 8px; text-align: center; color: ${textColor};">
                <div style="font-size: ${baseFontSize * 0.875}px; opacity: 0.7; margin-bottom: ${baseFontSize * 0.25}px;">æ¹¿åº¦</div>
                <div style="font-size: ${baseFontSize * 1.75}px; font-weight: bold; color: ${primaryAccent};">${current.relative_humidity_2m}%</div>
              </div>
              <div class="weather-metric" style="background-color: rgba(59, 130, 246, 0.1); padding: ${baseFontSize}px; border-radius: 8px; text-align: center; color: ${textColor};">
                <div style="font-size: ${baseFontSize * 0.875}px; opacity: 0.7; margin-bottom: ${baseFontSize * 0.25}px;">é¢¨é€Ÿ</div>
                <div style="font-size: ${baseFontSize * 1.75}px; font-weight: bold; color: ${primaryAccent};">${current.wind_speed_10m} m/s</div>
              </div>
              <div class="weather-metric" style="background-color: rgba(59, 130, 246, 0.1); padding: ${baseFontSize}px; border-radius: 8px; text-align: center; color: ${textColor};">
                <div style="font-size: ${baseFontSize * 0.875}px; opacity: 0.7; margin-bottom: ${baseFontSize * 0.25}px;">é¢¨å‘</div>
                <div style="font-size: ${baseFontSize * 1.75}px; font-weight: bold; color: ${primaryAccent};">${getWindDirection(current.wind_direction_10m)}</div>
              </div>
            </div>
          `;
        }
      }
    }

    async function updateTyphoonDisplay() {
      const config = window.elementSdk?.config || defaultConfig;
      const baseFontSize = config.font_size || defaultConfig.font_size;
      const textColor = config.text_color || defaultConfig.text_color;
      const secondaryAccent = config.secondary_accent || defaultConfig.secondary_accent;
      
      typhoonData = await fetchTyphoonData();
      
      const typhoonDiv = document.getElementById('typhoon-container');
      if (typhoonDiv) {
        if (typhoonData.length > 0) {
          typhoonDiv.innerHTML = `
            <h3 style="font-size: ${baseFontSize * 1.5}px; font-weight: bold; margin: 0 0 ${baseFontSize}px 0; color: ${textColor};">å°é¢¨æƒ…å ±</h3>
            <div style="display: flex; flex-direction: column; gap: ${baseFontSize * 0.75}px;">
              ${typhoonData.map(typhoon => `
                <div style="padding: ${baseFontSize}px; background-color: rgba(239, 68, 68, 0.1); border-left: 4px solid ${secondaryAccent}; border-radius: 6px; color: ${textColor};">
                  <div style="font-size: ${baseFontSize}px; font-weight: 600;">${typhoon.title}</div>
                  <div style="font-size: ${baseFontSize * 0.75}px; opacity: 0.7; margin-top: ${baseFontSize * 0.25}px;">${new Date(typhoon.updated).toLocaleString('ja-JP')}</div>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          typhoonDiv.innerHTML = `
            <h3 style="font-size: ${baseFontSize * 1.5}px; font-weight: bold; margin: 0 0 ${baseFontSize}px 0; color: ${textColor};">å°é¢¨æƒ…å ±</h3>
            <p style="font-size: ${baseFontSize}px; color: ${textColor}; text-align: center; padding: ${baseFontSize * 2}px;">ç¾åœ¨ã€å°é¢¨ã¯ç™ºç”Ÿã—ã¦ã„ã¾ã›ã‚“</p>
          `;
        }
      }
    }

    function setupRadarControls() {
      const playBtn = document.getElementById('radar-play');
      const stopBtn = document.getElementById('radar-stop');
      const latestBtn = document.getElementById('radar-latest');
      
      if (playBtn) {
        playBtn.addEventListener('click', playRadarAnimation);
      }
      
      if (stopBtn) {
        stopBtn.addEventListener('click', stopRadarAnimation);
      }
      
      if (latestBtn) {
        latestBtn.addEventListener('click', () => {
          stopRadarAnimation();
          currentRadarIndex = radarTimes.length - 1;
          displayRadarAtIndex(currentRadarIndex);
          updateRadarTimeDisplay();
        });
      }
    }

    async function onConfigChange(config) {
      await renderApp();
    }

    const element = {
      defaultConfig,
      onConfigChange,
      mapToCapabilities: (config) => ({
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ background_color: value });
              }
            }
          },
          {
            get: () => config.card_color || defaultConfig.card_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ card_color: value });
              }
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ text_color: value });
              }
            }
          },
          {
            get: () => config.primary_accent || defaultConfig.primary_accent,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ primary_accent: value });
              }
            }
          },
          {
            get: () => config.secondary_accent || defaultConfig.secondary_accent,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ secondary_accent: value });
              }
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => {
            if (window.elementSdk) {
              window.elementSdk.setConfig({ font_family: value });
            }
          }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (value) => {
            if (window.elementSdk) {
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }
      }),
      mapToEditPanelValues: (config) => new Map([
        ["main_title", config.main_title || defaultConfig.main_title],
        ["subtitle_text", config.subtitle_text || defaultConfig.subtitle_text],
        ["footer_text", config.footer_text || defaultConfig.footer_text]
      ])
    };

    if (window.elementSdk) {
      window.elementSdk.init(element);
    }

    (async () => {
      await detectLocation();
      await renderApp();
    })();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9be4c7e9e219f661',t:'MTc2ODQ3Mzg5OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

